# Bug ä¿®å¤è®°å½•

æœ¬æ–‡ä»¶è®°å½• MHC Ops é¡¹ç›®ä¸­çš„ bug ä¿®å¤è¿‡ç¨‹ã€‚

---

## Bug #1: dbias ç²¾åº¦é—®é¢˜

**æ—¥æœŸ**: 2025-02-25
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### é—®é¢˜ç°è±¡
- dbias_res max error: 0.82
- dbias_pre å’Œ dbias_post å®Œç¾æ­£ç¡® (error < 5e-7)
- 13/16 ä¸ªå…ƒç´ è¯¯å·® > 0.1

### æ ¹æœ¬åŸå› 
1. **åµŒå¥—å¾ªç¯å¯¼è‡´é‡å¤ç´¯åŠ **ï¼šdbias_res çš„è®¡ç®—ä½¿ç”¨äº†åµŒå¥—å¾ªç¯ï¼Œå¯¼è‡´æ¯ä¸ª (b, s) çš„ç¨‹åºæ‰§è¡Œ nÃ—n æ¬¡ç´¯åŠ 
2. **å˜é‡é”™è¯¯**ï¼šç´¯ç§¯äº† `dh_res1 = dh_res * a_res` è€Œä¸æ˜¯ `dh_res`

### ä¿®å¤æ–¹æ¡ˆ
**æ–‡ä»¶**: `src/backward/mhc_backward_triton.py:177-193`

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰:
for i in range(0, n, BLOCK_SIZE_N):
    for j in range(0, n, BLOCK_SIZE_N):
        dh_res1_chunk = tl.load(...) * a_res
        tl.atomic_add(dbias_ptr + dbias_offset, dh_res1_chunk, ...)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰:
dbias_res_offset = 2 * n + x_off_n[:, None] * n + x_off_n[None, :]
tl.atomic_add(dbias_ptr + dbias_res_offset, dh_res_block, mask=dh_res_mask)
```

### ä¿®å¤æ•ˆæœ
- dbias max error: ä» 0.82 é™è‡³ **1.3e-5** (æå‡ 63,000 å€!)
- dbias ç°å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•

### å…³é”®ç»éªŒ
- åµŒå¥—å¾ªç¯åœ¨ Triton ä¸­å®¹æ˜“å¯¼è‡´é‡å¤ç´¯åŠ 
- åœ¨ atomic_add æ—¶éœ€è¦ç¡®ä¿æ¯ä¸ªç¨‹åºåªè´¡çŒ®ä¸€æ¬¡
- ä½¿ç”¨å·²åŠ è½½çš„æ•°æ®å—å¯ä»¥é¿å…é‡å¤åŠ è½½å’Œé‡å¤ç´¯åŠ 

---

## Bug #2: dgamma ç²¾åº¦é—®é¢˜

**æ—¥æœŸ**: 2025-02-25
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### é—®é¢˜ç°è±¡
- dgamma max error: 6.53
- dgamma mean error: 1.16
- 47.9% çš„å…ƒç´ è¯¯å·® > 1.0
- åªæœ‰ 5.9% çš„å…ƒç´ è¯¯å·® < 0.1

### è¯Šæ–­è¿‡ç¨‹

#### ç¬¬ä¸€æ­¥ï¼šéš”ç¦» kernel 4 æµ‹è¯• âœ…
åˆ›å»º `test/test_kernel4_isolated.py`ï¼Œä½¿ç”¨ golden dvecX_mm ä½œä¸ºè¾“å…¥ï¼š
- **ç»“æœ**: âœ… PASS (max_err < 7e-5)
- **ç»“è®º**: Kernel 4 çš„é€»è¾‘å®Œå…¨æ­£ç¡®ï¼Œé—®é¢˜åœ¨ dvecX_mm è®¡ç®—

#### ç¬¬äºŒæ­¥ï¼šç¡®è®¤ nD_start å¾ªç¯æ­£ç¡®æ‰§è¡Œ âœ…
åˆ›å»º `test/diagnose_dvecX_mm_loop.py`ï¼Œç»Ÿè®¡å¾ªç¯æ‰§è¡Œæ¬¡æ•°ï¼š
- **ç»“æœ**: å¾ªç¯æ­£ç¡®æ‰§è¡Œ 4 æ¬¡
- **ç»“è®º**: æ‰€æœ‰é—®é¢˜éƒ½åœ¨è®¡ç®—é€»è¾‘ä¸­ï¼Œä¸åœ¨æ§åˆ¶æµ

#### ç¬¬ä¸‰æ­¥ï¼šåˆ†æå„éƒ¨åˆ†è¯¯å·®åˆ†å¸ƒ âœ…
åˆ›å»º `test/isolate_dh_res1_effect.py`ï¼š
- **ç»“æœ**:
  - å‰ 2n å…ƒç´ ï¼ˆdh_pre1 + dh_post1ï¼‰: max error = 2.29
  - å nÂ² å…ƒç´ ï¼ˆdh_res1ï¼‰: max error = 4.65
- **ç»“è®º**: æ‰€æœ‰éƒ¨åˆ†éƒ½æœ‰è¯¯å·®ï¼Œdh_res1 éƒ¨åˆ†æ›´ä¸¥é‡

#### ç¬¬å››æ­¥ï¼šéªŒè¯åµŒå¥—å¾ªç¯è®¡ç®—æ­£ç¡®æ€§ âœ…
åˆ›å»º `test/debug_dh_res1_loop.py`ï¼Œæ¨¡æ‹Ÿ Triton åµŒå¥—å¾ªç¯ï¼š
- **ç»“æœ**: æ¨¡æ‹Ÿè®¡ç®—ä¸ golden å®Œå…¨ä¸€è‡´ (error < 3e-6)
- **ç»“è®º**: åµŒå¥—å¾ªç¯çš„è®¡ç®—é€»è¾‘æœ¬èº«æ­£ç¡®ï¼Œé—®é¢˜åœ¨å…¶ä»–åœ°æ–¹

#### ç¬¬äº”æ­¥ï¼šå‘ç°çœŸæ­£çš„é—®é¢˜ âœ…
å¯¹æ¯” Parts 1, 2, 3 çš„ä»£ç ï¼Œå‘ç°ï¼š
- Part 1: `(dh_pre1 * inv_rms)[:, None] * phi_pre`
- Part 2: `(dh_post1 * inv_rms)[:, None] * phi_post`
- Part 3: `dh_res1[:, :, None] * phi_res` âŒ **ç¼ºå°‘ inv_rms!**

### æ ¹æœ¬åŸå› 
**Part 3 (dh_res1 @ phi[2n:, :]) çš„è®¡ç®—ç¼ºå°‘ `inv_rms` ä¹˜æ³•**

æ ¹æ® dh_mix çš„å®šä¹‰ï¼š
```python
dh_mix = dh_mix_tmp * inv_rms[:, :, None]
dh_mix_tmp = cat([dh_pre1, dh_post1, dh_res1.reshape(n*n)])
```

æ‰€æœ‰ä¸‰ä¸ªéƒ¨åˆ†éƒ½åº”è¯¥ä¹˜ä»¥ `inv_rms`ï¼Œä½† Triton kernel çš„ Part 3 é—æ¼äº†ã€‚

### ä¿®å¤æ–¹æ¡ˆ
**æ–‡ä»¶**: `src/backward/mhc_backward_triton.py:240-243`

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰:
temp = tl.sum(dh_res1[:, :, None] * phi_res, axis=0)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰:
temp = tl.sum((dh_res1 * inv_rms)[:, :, None] * phi_res, axis=0)
```

### ä¿®å¤æ•ˆæœ
- dgamma max error: ä» 6.53 é™è‡³ **0.000069** (æå‡ 100,000 å€!)
- dgamma mean error: ä» 1.16 é™è‡³ **0.000009**
- dgamma ç°å·²é€šè¿‡æ‰€æœ‰æµ‹è¯• âœ…

### æµ‹è¯•ç»“æœå¯¹æ¯”

| ç»„ä»¶ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| dphi | 8e-6 | 8e-6 | âœ… PASS |
| dalpha | 1.8e-4 | 6.1e-5 | âœ… PASS |
| dbias | 1.3e-5 | 6e-6 | âœ… PASS |
| dgamma | **6.53** | **6.9e-5** | âœ… PASS |
| dx | 45.25 | 45.25 | âŒ FAIL (å¾…ä¿®å¤) |

### å…³é”®ç»éªŒ

1. **éš”ç¦»æµ‹è¯•æå…¶æœ‰æ•ˆ**
   - Kernel 4 éš”ç¦»æµ‹è¯• â†’ æ’é™¤ kernel 4 é—®é¢˜
   - å¾ªç¯è¯Šæ–­ â†’ æ’é™¤æ§åˆ¶æµé—®é¢˜
   - åˆ†éƒ¨è¯¯å·®åˆ†æ â†’ å®šä½é—®é¢˜åŒºåŸŸ
   - æ¨¡æ‹Ÿè®¡ç®— â†’ éªŒè¯ç®—æ³•é€»è¾‘

2. **ä»£ç å¯¹æ¯”çš„é‡è¦æ€§**
   - å¯¹æ¯”ç›¸ä¼¼çš„ä»£ç å—ï¼ˆPart 1 vs Part 2 vs Part 3ï¼‰
   - å‘ç°ä¸ä¸€è‡´ä¹‹å¤„ï¼ˆinv_rms çš„ä½¿ç”¨ï¼‰
   - è¿™æ˜¯ä¸€ä¸ªç®€å•ä½†å®¹æ˜“è¢«é—æ¼çš„é”™è¯¯

3. **ç³»ç»Ÿæ€§è¯Šæ–­æµç¨‹**
   ```
   é—®é¢˜ç°è±¡ â†’ éš”ç¦»æµ‹è¯• â†’ é€æ­¥æ’é™¤ â†’ å¯¹æ¯”åˆ†æ â†’ å‘ç°æ ¹å›  â†’ ç²¾å‡†ä¿®å¤
   ```

4. **å°æ”¹åŠ¨ï¼Œå¤§å½±å“**
   - åªæ·»åŠ äº†ä¸€ä¸ª `* inv_rms` æ“ä½œ
   - ä½†ç²¾åº¦æå‡äº† 100,000 å€
   - è¯´æ˜æ•°å€¼è®¡ç®—ä¸­æ¯ä¸ªç»†èŠ‚éƒ½å¾ˆé‡è¦

### åˆ›å»ºçš„è¯Šæ–­æ–‡ä»¶

- `test/analyze_dgamma.py` - dgamma æ•´ä½“è¯¯å·®åˆ†æ
- `test/test_kernel4_isolated.py` - kernel 4 éš”ç¦»æµ‹è¯•
- `test/diagnose_dvecX_mm_loop.py` - nD_start å¾ªç¯è¯Šæ–­
- `test/simple_dgamma_check.py` - åˆ†å—è¯¯å·®åˆ†æ
- `test/isolate_dh_res1_effect.py` - dh_res1 éš”ç¦»æµ‹è¯•
- `test/debug_dh_res1_loop.py` - åµŒå¥—å¾ªç¯æ¨¡æ‹ŸéªŒè¯
- `test/debug_discrepancy.py` - è®¡ç®—é€»è¾‘éªŒè¯
- `test/debug_all_parts.py` - æ‰€æœ‰éƒ¨åˆ†çš„è¯¦ç»†åˆ†æ

---

## Bug #3: dx ç²¾åº¦é—®é¢˜

**æ—¥æœŸ**: 2025-02-25
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### é—®é¢˜ç°è±¡
- dx max error: 45.25
- dx mean error: 2.36
- 49% çš„å…ƒç´ è¯¯å·® > 1.0 (32,179/65,536)
- n_idx=0 æ— è¯¯å·®ï¼Œn_idx=1,2,3 æœ‰å¤§è¯¯å·®

### æ ¹æœ¬åŸå› 

**Kernel 2 çš„ grid é…ç½®é”™è¯¯ï¼**

```python
# é”™è¯¯çš„é…ç½®:
grid2 = (B * S, triton.cdiv(n, BLOCK_SIZE_N))  # = (128, 1)

# kernel 2 ä¸­:
n_idx = tl.program_id(axis=1)  # æ€»æ˜¯ = 0ï¼

# ç»“æœ: åªæœ‰ n_idx=0 è¢«å¤„ç†ï¼Œn_idx=1,2,3 å®Œå…¨æ²¡æœ‰è¢«è®¡ç®—
```

å¯¼è‡´ n_idx=1,2,3 çš„ dx è¾“å‡ºä¸º**å…¨é›¶**ã€‚

### ä¿®å¤æ–¹æ¡ˆ

**æ–‡ä»¶**: `src/backward/mhc_backward_triton.py:612`

```python
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰:
grid2 = (B * S, triton.cdiv(n, BLOCK_SIZE_N))

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰:
grid2 = (B * S, n)
```

### ä¿®å¤æ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| dx max error | 45.25 | 0.25 | **180 å€** |
| dx mean error | 2.36 | 0.0063 | **374 å€** |
| å…ƒç´ è¯¯å·® > 1.0 | 32,179 (49%) | **0** (0%) | å®Œç¾ï¼ |
| å…ƒç´ è¯¯å·® < 0.1 | ~20% | ~99.9% | å‡ ä¹å…¨éƒ¨ï¼ |

### è¯Šæ–­è¿‡ç¨‹

**ç¬¬ä¸€æ­¥ï¼šåˆ†è§£ dx æµ‹è¯•** (5 åˆ†é’Ÿ)
- åˆ›å»º `test/decompose_dx.py`
- å‘ç° n_idx=1,2,3 çš„ Triton dx è¾“å‡ºä¸º**å…¨é›¶**
- ç«‹å³å®šä½åˆ° grid é…ç½®é—®é¢˜

**ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ grid é…ç½®** (5 åˆ†é’Ÿ)
- å‘ç° grid2 ç¬¬äºŒç»´åªæœ‰ 1
- n_idx æ€»æ˜¯ = 0

**ç¬¬ä¸‰æ­¥ï¼šä¿®å¤å¹¶éªŒè¯** (10 åˆ†é’Ÿ)
- ä¿®æ”¹ grid é…ç½®
- æµ‹è¯•éªŒè¯

### å…³é”®ç»éªŒ

1. **Grid é…ç½®å¿…é¡»è¦†ç›–æ‰€æœ‰è¾“å‡ºç»´åº¦**
   - 2D grid çš„ç»´åº¦å¿…é¡»ä¸ program_id ä½¿ç”¨åŒ¹é…
   - å…¨é›¶è¾“å‡ºæ˜¯ grid é…ç½®é”™è¯¯çš„æ˜æ˜¾ä¿¡å·

2. **ä¸€æ­¥è¯Šæ–­å³å¯å®šä½**
   - åˆ†è§£æµ‹è¯•ç«‹å³å‘ç°é—®é¢˜
   - ç³»ç»ŸåŒ–è¯Šæ–­æµç¨‹éå¸¸æœ‰æ•ˆ

3. **bfloat16 ç²¾åº¦é™åˆ¶**
   - 0.25 çš„ max error å¯¹äº bfloat16 è¾“å…¥å¯æ¥å—
   - è¯¯å·®æ˜¯ 0.125 çš„å€æ•°

---

**æœ€åæ›´æ–°**: 2025-02-25
**æ€»ä½“è¿›åº¦**: **5/5 ç»„ä»¶é€šè¿‡æµ‹è¯•ï¼** âœ…
**MHC Backward Triton å®ç°å·²å®Œå…¨åŠŸèƒ½ï¼** ğŸ‰
